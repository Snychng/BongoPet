# 前端状态管理文档

## 概述

BongoPet 使用 Pinia 作为状态管理库，采用组合式 API 风格定义 store。整个应用的状态被合理地拆分为 5 个独立的 store，每个 store 负责特定的业务领域，实现了清晰的职责分离和高效的状态管理。

## Store 架构

```
src/stores/
├── app.ts        # 应用基础信息管理
├── cat.ts        # 猫咪显示和行为状态
├── general.ts    # 通用设置状态
├── model.ts      # Live2D模型管理
└── shortcut.ts   # 快捷键配置管理
```

## 详细分析

### 1. 应用状态管理 (app.ts)

**职责**: 管理应用的基础信息和窗口状态

```typescript
export const useAppStore = defineStore('app', () => {
  const name = ref('')
  const version = ref('')
  const windowState = reactive<WindowState>({})

  const init = async () => {
    name.value = await getName()
    version.value = await getVersion()
  }

  return {
    name,
    version,
    windowState,
    init,
  }
})
```

**核心功能**:
- **应用信息**: 存储应用名称和版本号
- **窗口状态**: 管理窗口的各种状态信息
- **初始化**: 异步获取应用基础信息

**技术特点**:
- 使用 `ref` 管理简单状态
- 使用 `reactive` 管理复杂对象状态
- 提供异步初始化方法

### 2. 猫咪状态管理 (cat.ts)

**职责**: 管理猫咪的显示状态、行为模式和窗口属性

```typescript
export const useCatStore = defineStore('cat', () => {
  const visible = ref(true)
  const scale = ref(100)
  const opacity = ref(100)
  const mirrorMode = ref(false)
  const singleMode = ref(false)
  const mouseMirror = ref(false)
  const penetrable = ref(false)
  const alwaysOnTop = ref(true)

  return {
    visible,
    scale,
    opacity,
    mirrorMode,
    singleMode,
    mouseMirror,
    penetrable,
    alwaysOnTop,
  }
})
```

**状态详解**:
- **visible**: 猫咪窗口可见性控制
- **scale**: 猫咪显示缩放比例 (10-500)
- **opacity**: 窗口透明度 (0-100)
- **mirrorMode**: 水平镜像翻转模式
- **singleMode**: 单键模式（每只手只显示最后按键）
- **mouseMirror**: 鼠标镜像跟随模式
- **penetrable**: 窗口穿透模式
- **alwaysOnTop**: 窗口置顶模式

**设计特点**:
- 所有状态都是响应式的，UI 会自动同步
- 状态变化会触发对应的窗口 API 调用
- 支持实时调整和即时生效

### 3. 通用设置管理 (general.ts)

**职责**: 管理应用的通用设置和系统集成功能

```typescript
export const useGeneralStore = defineStore('general', () => {
  const autoCheckUpdate = ref(false)
  const autostart = ref(false)
  const taskbarVisibility = ref(false)
  const theme = ref<'auto' | Theme>('auto')
  const isDark = ref(false)

  return {
    autoCheckUpdate,
    autostart,
    taskbarVisibility,
    theme,
    isDark,
  }
})
```

**功能模块**:
- **autoCheckUpdate**: 自动检查更新开关
- **autostart**: 开机自启动设置
- **taskbarVisibility**: 任务栏图标显示控制
- **theme**: 主题模式（自动/亮色/暗色）
- **isDark**: 当前是否为暗色主题

**系统集成**:
- 与 Tauri 自启动插件集成
- 与系统主题检测集成
- 与窗口任务栏显示集成

### 4. 模型管理 (model.ts)

**职责**: 管理 Live2D 模型的加载、切换和状态

```typescript
export interface Model {
  id: string
  name: string
  path: string
  config: ModelConfig
}

export const useModelStore = defineStore('model', () => {
  const models = ref<Model[]>([])
  const currentModel = ref<Model>()
  const pressedKeys = ref<string[]>([])
  const loading = ref(false)

  const init = async () => {
    await loadModels()
    if (models.value.length > 0) {
      currentModel.value = models.value[0]
    }
  }

  return {
    models,
    currentModel,
    pressedKeys,
    loading,
    init,
  }
})
```

**核心功能**:
- **models**: 所有可用模型列表
- **currentModel**: 当前使用的模型
- **pressedKeys**: 当前按下的按键列表
- **loading**: 模型加载状态
- **init**: 异步初始化模型数据

**模型配置**:
```typescript
export interface ModelConfig {
  name: string
  author?: string
  version?: string
  description?: string
  keymap: Record<string, string>
  background?: string
}
```

**技术实现**:
- 支持动态加载和切换模型
- 管理按键映射和可视化
- 处理模型加载状态和错误

### 5. 快捷键管理 (shortcut.ts)

**职责**: 管理全局快捷键配置

```typescript
export type HotKey = 'visibleCat' | 'mirrorMode' | 'penetrable' | 'alwaysOnTop'

export const useShortcutStore = defineStore('shortcut', () => {
  const visibleCat = ref('')
  const visiblePreference = ref('')
  const mirrorMode = ref('')
  const penetrable = ref('')
  const alwaysOnTop = ref('')

  return {
    visibleCat,
    visiblePreference,
    mirrorMode,
    penetrable,
    alwaysOnTop,
  }
})
```

**快捷键功能**:
- **visibleCat**: 切换猫咪窗口显示/隐藏
- **visiblePreference**: 切换设置窗口显示/隐藏
- **mirrorMode**: 切换镜像模式
- **penetrable**: 切换窗口穿透
- **alwaysOnTop**: 切换窗口置顶

**集成方式**:
- 与 `useTauriShortcut` 组合式函数集成
- 支持系统级全局快捷键
- 实时响应快捷键变化

## 状态持久化

### 持久化策略

BongoPet 使用 Tauri 的文件系统 API 实现状态持久化：

```typescript
// 保存配置
const saveConfig = async () => {
  const config = {
    cat: catStore.$state,
    general: generalStore.$state,
    shortcut: shortcutStore.$state,
  }
  await writeTextFile('config.json', JSON.stringify(config))
}

// 加载配置
const loadConfig = async () => {
  try {
    const config = await readTextFile('config.json')
    const data = JSON.parse(config)
    
    catStore.$patch(data.cat)
    generalStore.$patch(data.general)
    shortcutStore.$patch(data.shortcut)
  } catch (error) {
    console.log('使用默认配置')
  }
}
```

### 持久化时机

1. **应用启动**: 自动加载保存的配置
2. **状态变化**: 使用 watch 监听关键状态变化并自动保存
3. **应用退出**: 在应用关闭前保存当前状态

## 状态同步机制

### 跨窗口状态同步

由于 BongoPet 采用双窗口架构，需要确保状态在两个窗口间同步：

```typescript
// 使用 Tauri 事件系统同步状态
const syncState = (key: string, value: any) => {
  emit('state-change', { key, value })
}

// 监听状态变化
listen('state-change', (event) => {
  const { key, value } = event.payload
  // 更新对应的 store 状态
})
```

### 响应式更新

所有 store 都使用 Vue 3 的响应式系统，确保：

1. **UI 自动更新**: 状态变化自动触发 UI 重新渲染
2. **副作用处理**: 使用 watch 监听状态变化并执行相应操作
3. **计算属性**: 基于基础状态计算派生状态

## 设计模式和最佳实践

### 1. 组合式 API 模式

所有 store 都使用组合式 API 风格：

```typescript
export const useExampleStore = defineStore('example', () => {
  // 状态定义
  const state = ref(initialValue)
  
  // 计算属性
  const computed = computed(() => state.value * 2)
  
  // 方法定义
  const action = () => {
    state.value++
  }
  
  return {
    state,
    computed,
    action,
  }
})
```

### 2. 职责分离原则

每个 store 都有明确的职责边界：
- **app**: 应用级别的基础信息
- **cat**: 猫咪相关的所有状态
- **general**: 通用设置和系统集成
- **model**: Live2D 模型管理
- **shortcut**: 快捷键配置

### 3. 类型安全

充分利用 TypeScript 提供类型安全：

```typescript
// 定义接口
export interface ModelConfig {
  name: string
  keymap: Record<string, string>
}

// 类型约束
export type HotKey = 'visibleCat' | 'mirrorMode' | 'penetrable' | 'alwaysOnTop'

// 泛型使用
const theme = ref<'auto' | Theme>('auto')
```

### 4. 异步处理

合理处理异步操作：

```typescript
const init = async () => {
  try {
    loading.value = true
    await loadData()
  } catch (error) {
    console.error('初始化失败:', error)
  } finally {
    loading.value = false
  }
}
```

## 性能优化

### 1. 按需响应

使用 `shallowRef` 和 `shallowReactive` 优化大对象：

```typescript
// 对于不需要深度响应的大对象
const models = shallowRef<Model[]>([])
```

### 2. 计算属性缓存

利用计算属性的缓存特性：

```typescript
const filteredModels = computed(() => {
  return models.value.filter(model => model.enabled)
})
```

### 3. 批量更新

使用 `$patch` 进行批量状态更新：

```typescript
catStore.$patch({
  scale: 150,
  opacity: 80,
  mirrorMode: true,
})
```

## 调试和开发工具

### Pinia DevTools

在开发环境中，Pinia 自动集成 Vue DevTools：

1. **状态查看**: 实时查看所有 store 的状态
2. **时间旅行**: 回溯状态变化历史
3. **状态编辑**: 直接在 DevTools 中修改状态

### 日志记录

在关键状态变化时添加日志：

```typescript
watch(() => catStore.visible, (newValue, oldValue) => {
  console.log(`猫咪可见性变化: ${oldValue} -> ${newValue}`)
})
```

## 扩展建议

### 1. 新增 Store

当需要新增功能时，考虑是否需要新的 store：

```typescript
// 示例：音频设置 store
export const useAudioStore = defineStore('audio', () => {
  const volume = ref(50)
  const muted = ref(false)
  
  return {
    volume,
    muted,
  }
})
```

### 2. 状态组合

对于复杂的业务逻辑，可以组合多个 store：

```typescript
export const useAppLogic = () => {
  const catStore = useCatStore()
  const modelStore = useModelStore()
  
  const isReady = computed(() => {
    return !modelStore.loading && catStore.visible
  })
  
  return {
    isReady,
  }
}
```

### 3. 插件扩展

利用 Pinia 插件系统扩展功能：

```typescript
// 自动持久化插件
const persistPlugin = ({ store }) => {
  store.$subscribe((mutation, state) => {
    localStorage.setItem(store.$id, JSON.stringify(state))
  })
}

pinia.use(persistPlugin)
```

## 总结

BongoPet 的状态管理系统具有以下特点：

1. **清晰的架构**: 按功能模块划分 store，职责明确
2. **类型安全**: 充分利用 TypeScript 类型系统
3. **响应式设计**: 基于 Vue 3 响应式系统，UI 自动同步
4. **持久化支持**: 集成文件系统实现配置持久化
5. **跨窗口同步**: 通过事件系统实现状态同步
6. **开发友好**: 支持 DevTools 调试和热重载

这种设计为应用提供了稳定、高效、易维护的状态管理解决方案。