# BongoPet 后端架构总览

## 概述

BongoPet 的后端基于 Tauri 框架构建，使用 Rust 语言开发。后端主要负责系统级功能，包括设备监听、游戏手柄支持、窗口管理、文件系统操作等。整个架构采用模块化设计，通过插件系统实现功能扩展。

## 技术栈

- **框架**: Tauri 2.0
- **语言**: Rust
- **构建工具**: Cargo
- **依赖管理**: Cargo.toml
- **跨平台支持**: Windows、macOS、Linux

## 项目结构

```
src-tauri/
├── src/
│   ├── main.rs           # 应用入口点
│   ├── lib.rs             # 核心库文件
│   ├── core/              # 核心功能模块
│   │   ├── mod.rs
│   │   ├── device.rs      # 设备事件监听
│   │   ├── gamepad.rs     # 游戏手柄支持
│   │   ├── prevent_default.rs  # 默认行为阻止
│   │   └── setup/         # 平台特定设置
│   │       ├── mod.rs
│   │       ├── common.rs  # 通用设置
│   │       └── macos.rs   # macOS特定设置
│   ├── plugins/           # 插件系统
│   │   └── window/        # 自定义窗口插件
│   └── utils/             # 工具模块
│       ├── mod.rs
│       └── fs_extra.rs    # 文件系统扩展
├── assets/                # 静态资源
├── capabilities/          # 权限配置
├── Cargo.toml            # 项目配置
├── tauri.conf.json       # Tauri配置
└── build.rs              # 构建脚本
```

## 核心架构

### 1. 应用入口 (main.rs & lib.rs)

**main.rs**:
- 极简的入口点，仅调用 `bongo_cat_lib::run()`
- 遵循 Tauri 最佳实践，将主要逻辑放在库文件中

**lib.rs**:
- 应用的核心配置和初始化逻辑
- 插件注册和命令处理器设置
- 窗口事件处理和应用生命周期管理

```rust
// 主要功能包括：
- 插件注册 (updater, fs, prevent_default, window)
- 命令处理器 (copy_dir, show_window, hide_window 等)
- 窗口事件监听和状态管理
- 应用运行时配置
```

### 2. 核心模块 (core/)

#### 设备监听 (device.rs)
- **功能**: 监听鼠标和键盘事件
- **事件类型**: 鼠标移动、点击、键盘按键
- **实现**: 使用 rdev 库进行跨平台设备事件监听
- **通信**: 通过 Tauri 事件系统向前端发送事件

#### 游戏手柄支持 (gamepad.rs)
- **功能**: 游戏手柄连接检测和输入处理
- **事件类型**: 按钮按下/释放、摇杆轴值变化
- **实现**: 使用 gilrs 库进行游戏手柄管理
- **特性**: 支持多手柄、实时状态更新

#### 平台特定设置 (setup/)
- **common.rs**: 通用平台设置（当前为空实现）
- **macos.rs**: macOS特定窗口样式和行为设置
  - 窗口集合行为配置
  - 标题栏样式设置
  - 事件处理优化

#### 默认行为阻止 (prevent_default.rs)
- **功能**: 根据调试模式配置默认行为阻止策略
- **调试模式**: 允许右键菜单和开发者工具
- **生产模式**: 阻止默认浏览器行为

### 3. 插件系统 (plugins/)

#### 自定义窗口插件 (window/)
- **独立的 Cargo 项目**: 具有自己的 Cargo.toml
- **命令集合**:
  - `show_window`: 显示指定窗口
  - `hide_window`: 隐藏指定窗口
  - `show_main_window`: 显示主窗口
  - `show_preference_window`: 显示偏好设置窗口
  - `set_always_on_top`: 设置窗口置顶
- **跨平台支持**: 针对不同平台的特定实现

### 4. 工具模块 (utils/)

#### 文件系统扩展 (fs_extra.rs)
- **copy_dir 命令**: 异步目录复制功能
- **特性**: 仅复制目录内容，不复制目录本身
- **实现**: 使用 fs_extra 库提供高效的文件操作

## 配置系统

### Tauri 配置 (tauri.conf.json)
- **应用信息**: 产品名称、版本、描述
- **构建配置**: 目标平台、资源打包
- **窗口设置**: 默认窗口属性、图标配置
- **插件配置**: updater、fs 等插件的具体设置
- **权限管理**: 通过 capabilities 定义应用权限

### 权限配置 (capabilities/default.json)
- **核心权限**: core:default, core:window:default
- **窗口权限**: window:default, window:allow-*
- **系统权限**: os:default, shell:allow-open
- **文件系统权限**: fs:default, fs:allow-*
- **插件权限**: updater:default 等

## 跨平台支持

### 平台特定配置
- **tauri.macos.conf.json**: macOS 特定配置
- **tauri.windows.conf.json**: Windows 特定配置
- **tauri.linux.conf.json**: Linux 特定配置

### 平台适配策略
- **条件编译**: 使用 `#[cfg(target_os = "...")]` 进行平台特定代码
- **模块化设计**: setup 模块中的平台特定实现
- **统一接口**: 对外提供一致的 API 接口

## 通信机制

### 前后端通信
1. **命令调用**: 前端通过 `invoke` 调用后端命令
2. **事件发送**: 后端通过 `emit` 向前端发送事件
3. **数据序列化**: 使用 serde 进行 JSON 序列化/反序列化

### 事件系统
- **设备事件**: mouse_move, mouse_click, key_press
- **游戏手柄事件**: gamepad_button, gamepad_axis
- **窗口事件**: window_moved, window_resized

## 性能优化

### 异步处理
- 所有 I/O 操作使用异步函数
- 设备监听在独立线程中运行
- 避免阻塞主线程

### 资源管理
- 及时释放不需要的资源
- 使用 Arc 和 Mutex 进行线程安全的状态共享
- 合理的错误处理和恢复机制

## 安全考虑

### 权限控制
- 最小权限原则，只授予必要的系统权限
- 通过 capabilities 精确控制 API 访问
- 文件系统访问限制在指定目录

### 输入验证
- 所有外部输入都进行验证和清理
- 使用类型安全的 Rust 特性防止内存安全问题
- 错误处理避免信息泄露

## 扩展性设计

### 插件架构
- 模块化的插件系统，易于添加新功能
- 独立的插件项目，便于维护和测试
- 标准化的插件接口

### 配置驱动
- 通过配置文件控制功能开关
- 支持运行时配置更新
- 平台特定配置覆盖

## 构建和部署

### 构建流程
1. **依赖解析**: Cargo 自动处理依赖关系
2. **代码编译**: Rust 编译器优化和检查
3. **资源打包**: Tauri 打包静态资源和二进制文件
4. **平台适配**: 生成平台特定的安装包

### 部署策略
- **自动更新**: 集成 updater 插件支持热更新
- **多平台发布**: 支持 Windows、macOS、Linux
- **签名和公证**: 确保应用安全性和可信度

## 总结

BongoPet 的后端架构体现了现代桌面应用开发的最佳实践：

1. **模块化设计**: 清晰的模块划分，职责明确
2. **跨平台支持**: 统一的代码库，平台特定优化
3. **性能优先**: 异步处理，资源优化
4. **安全可靠**: 权限控制，类型安全
5. **易于扩展**: 插件架构，配置驱动

这种架构设计确保了应用的稳定性、性能和可维护性，为用户提供了流畅的桌面宠物体验。